<!-- dollarId: issue.item,v 1.4 2001/08/03 01:19:43 richard Exp dollar-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>
Issue 166: Error when submitting a avatar - Roundup issue tracker

</title>
<link rel="stylesheet" type="text/css" href="@@file/style.css">
<meta http-equiv="Content-Type"
      content="text/html; charset=utf-8" />

<script type="text/javascript">
submitted = false;
function submit_once() {
    if (submitted) {
        alert("Your request is being processed.\nPlease be patient.");
        event.returnValue = 0;    // work-around for IE
        return 0;
    }
    submitted = true;
    return 1;
}

function help_window(helpurl, width, height) {
    HelpWin = window.open('https://openhatch.org/bugs/' + helpurl, 'RoundupHelpWindow', 'scrollbars=yes,resizable=yes,toolbar=no,height='+height+',width='+width);
}
</script>



</head>
<body class="body">

<table class="body">

<tr>
 <td class="page-header-left"><a href="/" title="OpenHatch"><img src="/static/images/the-logo-bluegreen-87px.png" width="87" height="60" alt="openhatch" /></a></td>
 <td class="page-header-top">
   <div id="body-title">
     <h2>
 
 
 Issue166
 
</h2>
   </div>
   <div id="searchbox">
     <form method="GET" action="issue">
       <input type="hidden" name="@columns"
              value="id,activity,title,creator,assignedto,status,milestone" />
       <input type="hidden" name="@sort" value="activity" />
       <input type="hidden" name="@group" value="priority" />
       <input id="search-text" name="@search_text" size="10" />
       <input type="submit" id="submit" name="submit"
              value="Search" />
     </form>
  </div>
 </td>
</tr>

<tr>
 <td rowspan="2" valign="top" class="sidebar">
  

  <p class="classblock">
    <b>This month: 0.13.10</b><br>
    <a href="/wiki/0.13.10">Goals (in wiki)</a><br>
    <a href="milestone19?@template=open">Bug list</a>
  </p>

  <form method="POST" action="https://openhatch.org/bugs/">
   <p class="classblock">
    <b>Issues</b><br>
    
    <a href="issue?status=-1,1,2,3,4,5,6,7,9,10&amp;@sort=-activity&amp;@search_text=&amp;@columns=id,activity,title,creator,status,milestone&amp;assignedto=-1&amp;@group=priority&amp;@dispname=Show Unassigned&amp;@filter=status,assignedto&amp;@pagesize=50&amp;@startwith=0">Show Unassigned</a><br>
    <a href="issue?status=-1,1,2,3,4,5,6,7,9,10&amp;@sort=-activity&amp;@search_text=&amp;@dispname=Show All&amp;@filter=status&amp;@group=priority&amp;@columns=id,activity,title,creator,assignedto,status,milestone&amp;@pagesize=50&amp;@startwith=0">Show All</a><br>
    <a href="issue?status=-1,1,2,3,4,5,6,7,9,10&amp;@sort=-activity&amp;@search_text=&amp;@columns=id,activity,title,creator,assignedto,status,milestone&amp;@dispname=Show Bitesized&amp;keyword=1&amp;@group=priority&amp;@filter=status,keyword&amp;@pagesize=50&amp;@startwith=0">Show Bitesized</a><br>
    <a href="issue?@template=search">Search</a><br>
    <input type="submit" class="form-small"
           value="Show issue:"><input class="form-small" size="4" type="text" name="@number">
    <input type="hidden" name="@type" value="issue">
    <input type="hidden" name="@action" value="show">
   </p>
  </form>

  

  

  

   <p class="userblock">
    <b>Login</b><br>
    <a href="https://openhatch.org/account/login/?next=/bugs/issue166">Click here to login.</a>
   </p>

  
  <p class="userblock">
   <b>Help</b><br>
   <a href="http://www.roundup-tracker.org/docs.html">Bug tracker docs</a>
  </p>
 </td>
 <td>
  
  
 </td>
</tr>
<tr>
 <td class="content">





<div>

<form method="POST" name="itemSynopsis"
      onsubmit="return submit_once()"
      enctype="multipart/form-data" action="issue166">

<table class="form">
<tr>
 <th class="required">Title</th>
 <td colspan="3">Error when submitting a avatar</td>
</tr>

<tr>
 <th>Milestone</th>
 <td>0.10.11</td>
 <th class="required">Priority</th>
 <td>bug</td>
</tr>

<tr>
 <th>Waiting On</th>
 <td>
  
  
  
 </td>
 <th>Status</th>
 <td>resolved</td>
</tr>

<tr>
 <th>Superseder</th>
 <td>
  
  
  
 </td>
 <th>Nosy List</th>
 <td>
  jesstess, paulproteus, richizo
  <br>
 </td>
</tr>

<tr>
 <th>Assigned To</th>
 <td>jesstess</td>
 <th>Keywords</th>
 <td>
  avatar
  
 </td>
</tr>







</table>
</form>



<p>Created on <b>2010-10-18.13:01:34</b> by <b>richizo</b>, last changed <b>2010-12-10.00:18:36</b> by <b>paulproteus</b>.</p>

<table class="files">
 <tr><th colspan="5" class="header">Files</th></tr>
 <tr>
  <th>File name</th>
  <th>Uploaded</th>
  <th>Type</th>
  <th>Edit</th>
  <th>Remove</th>
 </tr>
 <tr>
  <td>
   <a href="file98/gir_major.png">gir_major.png</a>
  </td>
  <td>
   <span>richizo</span>,
   <span>2010-11-24.06:48:00</span>
  </td>
  <td>image/png</td>
  <td>
  </td>
  <td>
   
  </td>
 </tr>
 <tr>
  <td>
   <a href="file100/gir_major_converted.png">gir_major_converted.png</a>
  </td>
  <td>
   <span>jesstess</span>,
   <span>2010-11-27.21:34:23</span>
  </td>
  <td>image/png</td>
  <td>
  </td>
  <td>
   
  </td>
 </tr>
 <tr>
  <td>
   <a href="file103/issue166.tar.gz">issue166.tar.gz</a>
  </td>
  <td>
   <span>jesstess</span>,
   <span>2010-12-04.17:55:31</span>
  </td>
  <td>application/x-compressed</td>
  <td>
  </td>
  <td>
   
  </td>
 </tr>
 <tr>
  <td>
   <a href="file102/pil_test.py">pil_test.py</a>
  </td>
  <td>
   <span>jesstess</span>,
   <span>2010-11-29.03:49:37</span>
  </td>
  <td>text/x-python</td>
  <td>
  </td>
  <td>
   
  </td>
 </tr>
 <tr>
  <td>
   <a href="file101/traceback.txt">traceback.txt</a>
  </td>
  <td>
   <span>jesstess</span>,
   <span>2010-11-29.03:47:05</span>
  </td>
  <td>text/plain</td>
  <td>
  </td>
  <td>
   
  </td>
 </tr>
</table>

<table class="messages">
 <tr><th colspan="4" class="header">Messages</th></tr>
 
  <tr>
   <th><a href="msg628">msg628 (view)</a></th>
   <th>Author: paulproteus</th>
   <th>Date: 2010-12-10.00:18:36</th>
   <th>
    
   </th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    <pre>Marking as resolved, 'cause we shipped it and it passes the tests!

Rich, do give this another shot now.</pre>
   </td>
  </tr>
 
 
  <tr>
   <th><a href="msg613">msg613 (view)</a></th>
   <th>Author: paulproteus</th>
   <th>Date: 2010-12-04.21:06:31</th>
   <th>
    
   </th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    <pre>Jess, thanks for looking into this in such depth.

re: "parts": That's created by buildout. Code like Django gets copied into there.

I can explain more, but maybe that's enough?

I'll push this right now, but I'll need a bit to fix up my local setup so that I
can test it well. I also added one patch on top to fix a spelling error in a
method name.</pre>
   </td>
  </tr>
 
 
  <tr>
   <th><a href="msg612">msg612 (view)</a></th>
   <th>Author: jesstess</th>
   <th>Date: 2010-12-04.17:55:31</th>
   <th>
    
   </th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    <pre>Attached is a tarball with a diff that has the site fail gracefully if an
exception is raised during image processing, instead of returning a 500, as well
as unit tests for this case and the separate but related case of uploading a
profile photo that Django catches as invalid. There are two other commits
removing unused imports/variables.

I noticed while writing this that large portions of the OpenHatch code,
including parts/, where the image processing happens, aren't in git. I took this
to mean "don't touch them" and worked with what I had left, but I'd be
interested in hearing why this is the setup (the patch probably would have been
different, too).

The changes pass test_sans_customs and visual inspection.</pre>
   </td>
  </tr>
 
 
  <tr>
   <th><a href="msg611">msg611 (view)</a></th>
   <th>Author: jesstess</th>
   <th>Date: 2010-12-03.16:16:25</th>
   <th>
    
   </th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    <pre>The uncaught Exception is:

&lt;class 'zlib.error'&gt; Error -5 while decompressing data: incomplete or truncated
stream 

(I've attached the full traceback as traceback.txt)

Digging into why this particular image causes this error has taken me down a bit
of a rabbit hole. If you run pil_test.py in the directory with 'gir_major.png',
you'll see that this error is only generated when the PIL PNG parser is fed the
PNG in chunks. If you feed it the whole file at once, there's no problem.

This suggests a bug in the PIL PNG parser, but I don't understand why chunking
other PNGs doesn't cause the same problem. I'll write up a bug report/inquiry
for the PIL folks when I have more information.</pre>
   </td>
  </tr>
 
 
  <tr>
   <th><a href="msg606">msg606 (view)</a></th>
   <th>Author: jesstess</th>
   <th>Date: 2010-11-27.21:34:23</th>
   <th>
    
   </th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    <pre>richizo, I also get a 500 when trying to upload your file as my profile picture.
Other pngs work, and if I convert your picture to another format and then back
to a png, uploading that new image works too.

This suggests that your png is corrupted, but I ran through both of the quick
ways to detect corrupted pngs on

<a href="http://stackoverflow.com/questions/2383973/an-efficient-way-to-detect-corrupted-png-files">http://stackoverflow.com/questions/2383973/an-efficient-way-to-detect-corrupted-png-files</a>

and there was no problem.

So, in the short term, can you use a different image (I've attached the
png-to-gif-to-png version of your original file, if you want to use that)? In
the long term, paulproteus, you have access to the server logs and can hopefully
find out more. This is 100% repeatable with richizo's image, as far as I can tell.</pre>
   </td>
  </tr>
 
 
  <tr>
   <th><a href="msg600">msg600 (view)</a></th>
   <th>Author: richizo</th>
   <th>Date: 2010-11-24.06:48:00</th>
   <th>
    
   </th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    <pre>Yes, the error still occurring. I attached the image that I tried to submit.

Thanks.</pre>
   </td>
  </tr>
 
 
  <tr>
   <th><a href="msg599">msg599 (view)</a></th>
   <th>Author: jesstess</th>
   <th>Date: 2010-11-24.02:23:17</th>
   <th>
    
   </th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    <pre>Hi richizo, and thanks for reporting this.

I wasn't able to reproduce this today (I tried changing my profile picture to a
variety of file types and sizes). Does this still happen for you?</pre>
   </td>
  </tr>
 
 
  <tr>
   <th><a href="msg525">msg525 (view)</a></th>
   <th>Author: richizo</th>
   <th>Date: 2010-10-18.13:01:33</th>
   <th>
    
   </th>
  </tr>
  <tr>
   <td colspan="4" class="content">
    <pre>Always when I try to submit a avatar (photo) at page[1], after clicking on 
"Upload" button, the site is redirected to other page[2] and a error 500 is 
showed (server error).

PS.: I'm trying to submit a figure in pgn format with 124KB.

[1] - <a href="http://openhatch.org/account/edit/photo/">http://openhatch.org/account/edit/photo/</a>
[2] - <a href="http://openhatch.org/account/edit/photo/do">http://openhatch.org/account/edit/photo/do</a></pre>
   </td>
  </tr>
 
</table>

<table class="history"><tr><th colspan="4" class="header">
History
</th></tr><tr>
<th>Date</th>
<th>User</th>
<th>Action</th>
<th>Args</th>
</tr>
<tr><td>2010-12-10&nbsp;00:18:36</td><td>paulproteus</td><td>set</td><td>status: need-review -> resolved<br />messages:
  + <a href="msg628">msg628</a></td></tr>
<tr><td>2010-12-04&nbsp;21:08:59</td><td>paulproteus</td><td>set</td><td>milestone: <a href="milestone2">0.10.11</a></td></tr>
<tr><td>2010-12-04&nbsp;21:06:31</td><td>paulproteus</td><td>set</td><td>messages:
  + <a href="msg613">msg613</a></td></tr>
<tr><td>2010-12-04&nbsp;17:55:32</td><td>jesstess</td><td>set</td><td>status: chatting -> need-review<br />files:
  + <a href="file103">issue166.tar.gz</a><br />messages:
  + <a href="msg612">msg612</a></td></tr>
<tr><td>2010-12-03&nbsp;16:16:25</td><td>jesstess</td><td>set</td><td>messages:
  + <a href="msg611">msg611</a></td></tr>
<tr><td>2010-11-29&nbsp;03:49:37</td><td>jesstess</td><td>set</td><td>files:
  + <a href="file102">pil_test.py</a></td></tr>
<tr><td>2010-11-29&nbsp;03:47:05</td><td>jesstess</td><td>set</td><td>files:
  + <a href="file101">traceback.txt</a></td></tr>
<tr><td>2010-11-28&nbsp;01:58:22</td><td>jesstess</td><td>set</td><td>assignedto: <a href="user12">jesstess</a></td></tr>
<tr><td>2010-11-27&nbsp;21:34:24</td><td>jesstess</td><td>set</td><td>files:
  + <a href="file100">gir_major_converted.png</a><br />messages:
  + <a href="msg606">msg606</a></td></tr>
<tr><td>2010-11-24&nbsp;06:48:01</td><td>richizo</td><td>set</td><td>files:
  + <a href="file98">gir_major.png</a><br />messages:
  + <a href="msg600">msg600</a></td></tr>
<tr><td>2010-11-24&nbsp;02:23:17</td><td>jesstess</td><td>set</td><td>status: unread -> chatting<br />nosy:
  + <a href="user12">jesstess</a><br />messages:
  + <a href="msg599">msg599</a></td></tr>
<tr><td>2010-10-18&nbsp;13:01:34</td><td>richizo</td><td>create</td><td></td></tr>
</table>

</div>

</td>
</tr>

</table>



</body>
</html>

<!-- SHA: cef943195fefd743431d22c020eef27edd6255e1 -->
